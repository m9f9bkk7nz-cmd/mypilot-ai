#!/bin/bash

# éƒ¨ç½²å‰æ£€æŸ¥è„šæœ¬
# ç¡®ä¿æ‰€æœ‰å¿…è¦çš„é…ç½®éƒ½å·²å°±ç»ª

echo "ğŸ” å¼€å§‹éƒ¨ç½²å‰æ£€æŸ¥..."
echo ""

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒå˜é‡..."
REQUIRED_VARS=(
  "DATABASE_URL"
  "NEXTAUTH_URL"
  "NEXTAUTH_SECRET"
  "STRIPE_SECRET_KEY"
  "RESEND_API_KEY"
)

MISSING_VARS=()

for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    MISSING_VARS+=("$var")
  fi
done

if [ ${#MISSING_VARS[@]} -gt 0 ]; then
  echo "âŒ ç¼ºå°‘ä»¥ä¸‹ç¯å¢ƒå˜é‡:"
  for var in "${MISSING_VARS[@]}"; do
    echo "   - $var"
  done
  echo ""
  echo "è¯·åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ è¿™äº›ç¯å¢ƒå˜é‡"
  exit 1
else
  echo "âœ… æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®"
fi

echo ""

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "ğŸ—„ï¸  æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
if npx prisma db pull --force > /dev/null 2>&1; then
  echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
else
  echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
  echo "è¯·æ£€æŸ¥ DATABASE_URL æ˜¯å¦æ­£ç¡®"
  exit 1
fi

echo ""

# æ£€æŸ¥ä¾èµ–
echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."
if npm list > /dev/null 2>&1; then
  echo "âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
else
  echo "âš ï¸  å‘ç°ä¾èµ–é—®é¢˜ï¼Œè¿è¡Œ npm install"
  npm install
fi

echo ""

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
if npm test > /dev/null 2>&1; then
  echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
else
  echo "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²"
fi

echo ""

# æ£€æŸ¥æ„å»º
echo "ğŸ—ï¸  æ£€æŸ¥æ„å»º..."
if npm run build > /dev/null 2>&1; then
  echo "âœ… æ„å»ºæˆåŠŸ"
else
  echo "âŒ æ„å»ºå¤±è´¥"
  exit 1
fi

echo ""
echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥éƒ¨ç½²äº†"
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "1. æäº¤ä»£ç : git add . && git commit -m 'Ready for deployment'"
echo "2. æ¨é€åˆ° GitHub: git push origin main"
echo "3. Vercel å°†è‡ªåŠ¨éƒ¨ç½²"
